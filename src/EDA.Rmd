---
title: "EDA"
author: "DSCI_522_Group304"
date: "1/16/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(readr)
library(janitor)
library(infer)
library(repr)
library(gridExtra)
library(ggridges)
```

### 1. Dataset Description

**Dataset: BC Schools - Foundational Skills Assessment(FSA)**

**License:** Open Government License - BC

**Source:** Published by the [Ministry of Education - Education Analytics](https://catalogue.data.gov.bc.ca/dataset/bc-schools-foundation-skills-assessment-fsa-)

**Content:** The results of the Grades 4 and 7 BC Foundation Skills Assessments in Numeracy, Reading and Writing from 2007/2008 to 2018/2019.

**Dataset Last Modified:** 2019-02-08


### 2. Load the dataset

```{r load data}
rawdata_2007_2016 <- read_csv('../data/fsa_2007-2016.csv')

rawdata_2017_2018 <- read_csv('../data/fsa_2017-2018.csv')
head(rawdata_2007_2016)
```

```{r data cleaning}
df_07_16 <- rawdata_2007_2016 %>%
  clean_names() %>%
  filter(score != 'Msk') %>%
  select(school_year, public_or_independent, sub_population, fsa_skill_code, grade, number_expected_writers, number_writers, score) %>%
  mutate(score = as.numeric(score),
         number_expected_writers = as.numeric(number_expected_writers),
         number_writers = as.numeric(number_writers))

df_17_18 <- rawdata_2017_2018 %>%
  clean_names() %>%
  filter(score != 'Msk') %>%
  select(school_year, public_or_independent, sub_population, fsa_skill_code, grade, number_expected_writers, number_writers, score) %>%
  mutate(score = as.numeric(score),
         number_expected_writers = as.numeric(number_expected_writers),
         number_writers = as.numeric(number_writers),
         public_or_independent = case_when(public_or_independent == "BC PUBLIC SCHOOL" ~ "BC Public School",
                                           public_or_independent == "BC INDEPENDENT SCHOOL" ~ "BC Independent School",
                                           public_or_independent == "PROVINCE-TOTAL" ~ "PROVINCE - TOTAL",
                                           TRUE ~ public_or_independent))
         
df <- bind_rows(df_07_16, df_17_18)

head(df)
```

### 3. Explore the dataset

```{r 3.1 structure of the cleaned dataset}
str(df)
```
```{r 3.2 Columns in cleaned dataframe}
cat("The dataframe columns in dataframe for 2007-2016 are", colnames(df), "\n\n")

cat("The SCHOOL_YEAR contains", unique(df$school_year), "\n\n")

cat("The PUBLIC_OR_INDEPENDENT contains", unique(df$public_or_independent), "\n\n")

cat("The SUB_POPULATION contains", length(unique(df$sub_population)), "subgroups, and they are", unique(df$sub_population), "\n\n")

cat("The FSA_SKILL_CODE contains", unique(df$fsa_skill_code), "\n\n")

cat("The GRADE contains", unique(df$grade), "\n\n")

cat("The SCORE ranges from", min(df$score), "to", max(df$score), "and the average is", mean(df$score), "\n\n")
```


### 4. Initial thoughts

The dataset includes mean FSA scores for many different subgroups which can be compared. Possible comparisons include:
- Female vs Male
- Aboriginal vs Non Aboriginal
- English Language Learner vs Non English Language Learner
- Grade 4 vs Grade 7
- Public School vs Independent School

FSA scores can also be compared across different school districts and by FSA Skill Code (Numeracy, Reading, or Writing components of the exam). 

- **Potential Research Questions:**

There are many questions we could ask about this dataset, including (but no limited to) the following:

Main Questions:
1. (Inferential) Is there a difference in how well BC Public School vs Independent School students perform on the FSA exam?
2. (Inferential) Is there a difference in how well Aboriginal vs Non Aboriginal students perform on the FSA exam?
3. (Predictive) Can we predict how well a student will perform on a Numeracy component of the FSA exam based on their school district, gender, how many special needs students are in the school, and the student's scores on the other exam components?

Subquestions:
4. (Descriptive) Which school type (Public / Independent) has a higher average FSA score across all school years?
5. (Descriptive) Which group of students (Aboriginal / Non Aboriginal) has a higher average FSA score across all school years?
6. (Exploratory) Are there trends in average FSA scores for Public or Independent School students between 2007/08 - 2018/19 school years?
7. (Exploratory) Are there trends in average FSA scores for Aboriginal or Non Aboriginal students between 2007/08 - 2018/19 school years?

### 5. Wrangling

```{r 5.1 subgroups}

subgroup <- function(group){
  sub_group <- df %>%
    filter(sub_population == group)
}

all_students <- subgroup('ALL STUDENTS') 

female <- subgroup('FEMALE') 

male <- subgroup('MALE')

aboriginal <- subgroup('ABORIGINAL')

non_aboriginal <- subgroup('NON ABORIGINAL') 

eng_lang_learner <- subgroup('ENGLISH LANGUAGE LEARNER') 

non_eng_lang_learner<- subgroup('NON ENGLISH LANGUAGE LEARNER') 

special <- subgroup('SPECIAL NEEDS NO GIFTED') 
```


### 6. Research Questions

- **Selected Research Questions**

**Question 1**

(Inferential) Is there a difference in how well Public school students vs Independent school students perform on the FSA?

- 2 Group Hypothesis Test (mean scores for all tests together, and tests separately): 
    - Null Hypothesis: No difference
    - Alternative Hypothesis: Difference
    
- Estimate + Confidence intervals of the mean scores for the different groups

**Question 2**

(Inferential) Is there a difference in how well Aboriginal vs Non aboriginal students perform on the FSA?

- 2 Group Hypothesis Test (mean scores for all tests together, and tests separately): 
    - Null Hypothesis: No difference
    - Alternative Hypothesis: Difference
    
- Estimate + Confidence intervals of the mean scores for the different groups

SELECTED SUBQUESTIONS:

- Comparing means

### 7. Data Analysis & Visualizations
```{r 7.0 ci function, echo = FALSE}
ci <- function(df, skill){
  one_sample <- df %>%
    filter(fsa_skill_code == skill) %>%
    rep_sample_n(size = 40) %>%
    ungroup() %>%
    select(score)
  one_sample %>%
    rep_sample_n(size = 40, reps = 1000, replace = TRUE) %>%
    summarize(stat = mean(score)) %>%
    get_ci()
}

ci_ind <- function(df, skill, ind){
  one_sample <- df %>%
    filter(fsa_skill_code == skill & public_or_independent == ind) %>%
    rep_sample_n(size = 40) %>%
    ungroup() %>%
    select(score)
  one_sample %>%
    rep_sample_n(size = 40, reps = 1000, replace = TRUE) %>%
    summarize(stat = mean(score)) %>%
    get_ci()
}
```

```{r 7.1.1 public vs independent in different subgroups in numeracy, echo=FALSE}
pub_ind_numeracy <- df %>%
  filter(fsa_skill_code == "Numeracy" & public_or_independent != 'PROVINCE - TOTAL') %>%
  group_by(sub_population, public_or_independent) %>%
  summarise(avg = mean(score))

low <- c(ci_ind(aboriginal, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(aboriginal, "Numeracy", "BC Public School")[[1]],
  ci_ind(all_students, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(all_students, "Numeracy", "BC Public School")[[1]],
  ci_ind(eng_lang_learner, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(eng_lang_learner, "Numeracy", "BC Public School")[[1]],
  ci_ind(female, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(female, "Numeracy", "BC Public School")[[1]],
  ci_ind(male, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(male, "Numeracy", "BC Public School")[[1]],
  ci_ind(non_aboriginal, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(non_aboriginal, "Numeracy", "BC Public School")[[1]],
  ci_ind(non_eng_lang_learner, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(non_eng_lang_learner, "Numeracy", "BC Public School")[[1]],
  ci_ind(special, "Numeracy", "BC Independent School")[[1]], 
  ci_ind(special, "Numeracy", "BC Public School")[[1]])

high <- c(ci_ind(aboriginal, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(aboriginal, "Numeracy", "BC Public School")[[2]],
  ci_ind(all_students, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(all_students, "Numeracy", "BC Public School")[[2]],
  ci_ind(eng_lang_learner, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(eng_lang_learner, "Numeracy", "BC Public School")[[2]],
  ci_ind(female, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(female, "Numeracy", "BC Public School")[[2]],
  ci_ind(male, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(male, "Numeracy", "BC Public School")[[2]],
  ci_ind(non_aboriginal, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(non_aboriginal, "Numeracy", "BC Public School")[[2]],
  ci_ind(non_eng_lang_learner, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(non_eng_lang_learner, "Numeracy", "BC Public School")[[2]],
  ci_ind(special, "Numeracy", "BC Independent School")[[2]], 
  ci_ind(special, "Numeracy", "BC Public School")[[2]])

  
sum_num <- tibble("sub_population" = pub_ind_numeracy$sub_population,
                  "public_or_independent" = pub_ind_numeracy$public_or_independent,
                  "avg" = pub_ind_numeracy$avg,
                  "2.5%" = low,
                  "97.5%" = high)
sum_num
```

```{r 7.2.1 Public vs Independent Bar Chart - Numeracy Test Results}

bar_plot_numeracy <- ggplot(sum_num, aes(x = sub_population, y = avg))+
      geom_col(aes(fill = public_or_independent), width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           fill = "School Type",
           title = "2007-2018 FSA - Numeracy Test ") +
      theme(legend.position = "bot") +
      coord_flip() +
      theme_bw()

bar_plot_numeracy

```

```{r 7.2.2 Public vs Independent Ridge Plot - Numeracy Test Results}

pub_ind_numeracy


ridge_plot <- ggplot(df, aes(x = score, y = sub_population, fill = sub_population)) +  
           geom_density_ridges(size = 0.5, alpha = 0.7, color = "black", 
                               scale = 2.0, rel_min_height = 0.01, quantile_lines = TRUE, quantiles = 4) +
           coord_cartesian(clip = "off") + # Required to plot top distribution completely
           labs(title ="2007-2018 FSA Test - BC Schools", 
                #subtitle = "(Source: Gapminder Dataset)", 
           x = "Score") +
           #scale_x_continuous(breaks = seq(30, 100, 5)) +
           theme_ridges() + 
           theme(legend.position = "none") +
           theme(axis.text.x = element_text(angle = 70, hjust = 1, size = 10, face = "bold"),
                 axis.text.y = element_text(angle = 0, hjust = 1, size = 10, face = "bold"))


#options(tidyverse.quiet = TRUE, repr.plot.width = 10, repr.plot.height = 5)

ridge_plot + facet_grid(cols = vars(fsa_skill_code))
```



```{r 7.2 public vs independent in different subgroups in reading, echo = FALSE}
pub_ind_reading <- df %>%
  filter(fsa_skill_code == "Reading" & public_or_independent != 'PROVINCE - TOTAL') %>%
  group_by(sub_population, public_or_independent) %>%
  summarise(avg = mean(score))

low <- c(ci_ind(aboriginal, "Reading", "BC Independent School")[[1]], 
  ci_ind(aboriginal, "Reading", "BC Public School")[[1]],
  ci_ind(all_students, "Reading", "BC Independent School")[[1]], 
  ci_ind(all_students, "Reading", "BC Public School")[[1]],
  ci_ind(eng_lang_learner, "Reading", "BC Independent School")[[1]], 
  ci_ind(eng_lang_learner, "Reading", "BC Public School")[[1]],
  ci_ind(female, "Reading", "BC Independent School")[[1]], 
  ci_ind(female, "Reading", "BC Public School")[[1]],
  ci_ind(male, "Reading", "BC Independent School")[[1]], 
  ci_ind(male, "Reading", "BC Public School")[[1]],
  ci_ind(non_aboriginal, "Reading", "BC Independent School")[[1]], 
  ci_ind(non_aboriginal, "Reading", "BC Public School")[[1]],
  ci_ind(non_eng_lang_learner, "Reading", "BC Independent School")[[1]], 
  ci_ind(non_eng_lang_learner, "Reading", "BC Public School")[[1]],
  ci_ind(special, "Reading", "BC Independent School")[[1]], 
  ci_ind(special, "Reading", "BC Public School")[[1]])

high <- c(ci_ind(aboriginal, "Reading", "BC Independent School")[[2]], 
  ci_ind(aboriginal, "Reading", "BC Public School")[[2]],
  ci_ind(all_students, "Reading", "BC Independent School")[[2]], 
  ci_ind(all_students, "Reading", "BC Public School")[[2]],
  ci_ind(eng_lang_learner, "Reading", "BC Independent School")[[2]], 
  ci_ind(eng_lang_learner, "Reading", "BC Public School")[[2]],
  ci_ind(female, "Reading", "BC Independent School")[[2]], 
  ci_ind(female, "Reading", "BC Public School")[[2]],
  ci_ind(male, "Reading", "BC Independent School")[[2]], 
  ci_ind(male, "Reading", "BC Public School")[[2]],
  ci_ind(non_aboriginal, "Reading", "BC Independent School")[[2]], 
  ci_ind(non_aboriginal, "Reading", "BC Public School")[[2]],
  ci_ind(non_eng_lang_learner, "Reading", "BC Independent School")[[2]], 
  ci_ind(non_eng_lang_learner, "Reading", "BC Public School")[[2]],
  ci_ind(special, "Reading", "BC Independent School")[[2]], 
  ci_ind(special, "Reading", "BC Public School")[[2]])

  
sum_read <- tibble("sub_population" = pub_ind_reading$sub_population,
                  "public_or_independent" = pub_ind_reading$public_or_independent,
                  "avg" = pub_ind_reading$avg,
                  "2.5%" = low,
                  "97.5%" = high)
sum_read

```

```{r 7.2.1 Public vs Independent Bar Chart - Reading Test Results}

bar_plot_reading <- ggplot(sum_read, aes(x = sub_population, y = avg))+
      geom_col(aes(fill = public_or_independent), width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           fill = "School Type",
           title = "2007-2018 FSA - Reading Test ") +
      theme(legend.position = "bot") +
      coord_flip() +
      theme_bw()

bar_plot_reading

```



```{r 7.3 public vs independent in different subgroups in writing, echo = FALSE}
pub_ind_writing <- df %>%
  filter(fsa_skill_code == "Writing" & public_or_independent != 'PROVINCE - TOTAL') %>%
  group_by(sub_population, public_or_independent) %>%
  summarise(avg = mean(score))

low <- c(ci_ind(aboriginal, "Writing", "BC Independent School")[[1]], 
  ci_ind(aboriginal, "Writing", "BC Public School")[[1]],
  ci_ind(all_students, "Writing", "BC Independent School")[[1]], 
  ci_ind(all_students, "Writing", "BC Public School")[[1]],
  ci_ind(eng_lang_learner, "Writing", "BC Independent School")[[1]], 
  ci_ind(eng_lang_learner, "Writing", "BC Public School")[[1]],
  ci_ind(female, "Writing", "BC Independent School")[[1]], 
  ci_ind(female, "Writing", "BC Public School")[[1]],
  ci_ind(male, "Writing", "BC Independent School")[[1]], 
  ci_ind(male, "Writing", "BC Public School")[[1]],
  ci_ind(non_aboriginal, "Writing", "BC Independent School")[[1]], 
  ci_ind(non_aboriginal, "Writing", "BC Public School")[[1]],
  ci_ind(non_eng_lang_learner, "Writing", "BC Independent School")[[1]], 
  ci_ind(non_eng_lang_learner, "Writing", "BC Public School")[[1]],
  ci_ind(special, "Writing", "BC Independent School")[[1]], 
  ci_ind(special, "Writing", "BC Public School")[[1]])

high <- c(ci_ind(aboriginal, "Writing", "BC Independent School")[[2]], 
  ci_ind(aboriginal, "Writing", "BC Public School")[[2]],
  ci_ind(all_students, "Writing", "BC Independent School")[[2]], 
  ci_ind(all_students, "Writing", "BC Public School")[[2]],
  ci_ind(eng_lang_learner, "Writing", "BC Independent School")[[2]], 
  ci_ind(eng_lang_learner, "Writing", "BC Public School")[[2]],
  ci_ind(female, "Writing", "BC Independent School")[[2]], 
  ci_ind(female, "Writing", "BC Public School")[[2]],
  ci_ind(male, "Writing", "BC Independent School")[[2]], 
  ci_ind(male, "Writing", "BC Public School")[[2]],
  ci_ind(non_aboriginal, "Writing", "BC Independent School")[[2]], 
  ci_ind(non_aboriginal, "Writing", "BC Public School")[[2]],
  ci_ind(non_eng_lang_learner, "Writing", "BC Independent School")[[2]], 
  ci_ind(non_eng_lang_learner, "Writing", "BC Public School")[[2]],
  ci_ind(special, "Writing", "BC Independent School")[[2]], 
  ci_ind(special, "Writing", "BC Public School")[[2]])

  
sum_write <- tibble("sub_population" = pub_ind_writing$sub_population,
                  "public_or_independent" = pub_ind_writing$public_or_independent,
                  "avg" = pub_ind_writing$avg,
                  "2.5%" = low,
                  "97.5%" = high)
sum_write
```

```{r 7.3.1 Public vs Independent Bar Chart - Writing Test Results}

bar_plot_writing <- ggplot(sum_write, aes(x = sub_population, y = avg))+
      geom_col(aes(fill = public_or_independent), width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           fill = "School Type",
           title = "2007-2018 FSA - Writing Test ") +
      theme(legend.position = "bot") +
      coord_flip() +
      theme_bw()

bar_plot_writing

```



```{r 7.4 aboriginal vs non-aboriginal in numeracy}
non_ab_numeracy <- df %>%
  filter(fsa_skill_code == "Numeracy" & public_or_independent == 'PROVINCE - TOTAL') %>%
  filter(sub_population == "ABORIGINAL" | sub_population == "NON ABORIGINAL") %>%
  group_by(sub_population) %>%
  summarise(avg = mean(score))

sum_ab_num <- tibble("sub_population" = non_ab_numeracy$sub_population,
                  "avg" = non_ab_numeracy$avg,
                  "2.5%" = c(ci(aboriginal, "Numeracy")[[1]], ci(non_aboriginal, "Numeracy")[[1]]),
                  "97.5%" = c(ci(aboriginal, "Numeracy")[[2]], ci(non_aboriginal, "Numeracy")[[2]]))
sum_ab_num

```

```{r 7.4.1 aboriginal vs non-aboriginal Bar Chart - Numeracy Test Results}

ab_bar_plot_numeracy <- ggplot(sum_ab_num, aes(x = sub_population, y = avg))+
      geom_col(width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           title = "BC Schols 2007-2018 FSA - Numeracy Test ") +
      theme(legend.position = "bot") +
      theme_bw()

ab_bar_plot_numeracy

```


```{r 7.5 aboriginal vs non-aboriginal in reading}
non_ab_reading <- df %>%
  filter(fsa_skill_code == "Reading" & public_or_independent == 'PROVINCE - TOTAL') %>%
  filter(sub_population == "ABORIGINAL" | sub_population == "NON ABORIGINAL") %>%
  group_by(sub_population) %>%
  summarise(avg = mean(score))

sum_ab_read <- tibble("sub_population" = non_ab_reading$sub_population,
                  "avg" = non_ab_reading$avg,
                  "2.5%" = c(ci(aboriginal, "Reading")[[1]], ci(non_aboriginal, "Reading")[[1]]),
                  "97.5%" = c(ci(aboriginal, "Reading")[[2]], ci(non_aboriginal, "Reading")[[2]]))
sum_ab_read

```

```{r 7.5.1 aboriginal vs non-aboriginal Bar Chart - Reading Test Results}

ab_bar_plot_numeracy <- ggplot(sum_ab_read, aes(x = sub_population, y = avg))+
      geom_col(width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           title = "BC Schools 2007-2018 FSA - Reading Test ") +
      theme(legend.position = "bot") +
      theme_bw()

ab_bar_plot_numeracy
```


```{r 7.6 aboriginal vs non-aboriginal in writing}
non_ab_writing <- df %>%
  filter(fsa_skill_code == "Writing" & public_or_independent == 'PROVINCE - TOTAL') %>%
  filter(sub_population == "ABORIGINAL" | sub_population == "NON ABORIGINAL") %>%
  group_by(sub_population) %>%
  summarise(avg = mean(score))

sum_ab_write <- tibble("sub_population" = non_ab_writing$sub_population,
                  "avg" = non_ab_writing$avg,
                  "2.5%" = c(ci(aboriginal, "Writing")[[1]], ci(non_aboriginal, "Writing")[[1]]),
                  "97.5%" = c(ci(aboriginal, "Writing")[[2]], ci(non_aboriginal, "Writing")[[2]]))
sum_ab_write
```

```{r 7.6.1 aboriginal vs non-aboriginal Bar Chart - WritingTest Results}

ab_bar_plot_numeracy <- ggplot(sum_ab_write, aes(x = sub_population, y = avg))+
      geom_col(width = 0.7 , alpha=0.9 , size=0.3, colour="black",position = "dodge") +
      labs(y = "Average Score",
           x = "Sub_Group",
           title = "BC Schools 2007-2018 FSA - Reading Test ") +
      theme(legend.position = "bot") +
      theme_bw()

ab_bar_plot_numeracy

```



### 8. Summary & Conclusion

This section will be completed after the actual project analysis is completed.
